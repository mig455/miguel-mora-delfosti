@page "/login"
@using BlazorApp1.Models
@using BlazorApp1.Services
@using Blazored.LocalStorage
@inject ApiService ApiService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILocalStorageService LocalStorageService
@inject NotificationService NotificationService
<HeadContent>
    <link href="css/login.css" rel="stylesheet" />
</HeadContent>


@if (isAuthenticated)
{
    <div class="alert alert-warning" role="alert">
        Ya estás logueado. Redirigiendo a la página de proyectos...
    </div>
}
else
{
    <div class="contentLogin">
        <h3>Login</h3>
        <EditForm Model="user" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="username">Nombre de usuario</label>
                <InputText id="username" class="form-control" @bind-Value="user.Username" />
            </div>
            <div class="form-group">
                <label for="password">Contraseña</label>
                <InputText id="password" class="form-control" type="password" @bind-Value="user.Password" />
            </div>
            <div class="botones">
                <button type="submit" class="btn btn-success btn-sm">Ingresar</button>
                <button type="button" class="btn btn-primary btn-sm" @onclick="NavigateToRegister">Registrarse</button>
            </div>
        </EditForm>
    </div>

}


@code {
    private bool isAuthenticated = false;
    private User user = new User();
    private MainLayout Layout;
    protected override async Task OnInitializedAsync()
    {
        var token = await LocalStorageService.GetItemAsync<string>("authToken");
        if (!string.IsNullOrEmpty(token))
        {
            isAuthenticated = true;
            NavigationManager.NavigateTo("/projects");
        }
    }
    private void NavigateToRegister()
    {
        NavigationManager.NavigateTo("/register");
    }
    private async Task HandleLogin()
    {
        var authResponse = await ApiService.Login(user);
        if (authResponse != null && authResponse.Token != null)
        {
            await LocalStorageService.SetItemAsync("authToken", authResponse.Token);
            ((CustomAuthenticationStateProvider)AuthenticationStateProvider).MarkUserAsAuthenticated(authResponse.Token);
            ShowNotification("Logueeado satisfactoriamente", "alert-success");
            NavigationManager.NavigateTo("/projects");
            return;
        }
        ShowNotification("Ocurrio un error al Intentar ingresar", "alert-danger");
    }
    private void ShowNotification(string message, string alertType)
    {
        NotificationService.Notify(message, alertType);
    }
}